{% extends "base.html" %}

{% block content %}
<style>
    body {
        background-color: #1e1e1e;
        color: #e0e0e0;
    }
    .container {
        background-color: #2a2a2a;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .form-control, .form-select {
        background-color: #3a3a3a;
        border: none;
        color: #ffffff;
    }
    .btn-primary {
        background-color: #4CAF50;
        border: none;
    }
    .btn-primary:hover {
        background-color: #45a049;
    }
    .table {
        color: #e0e0e0;
    }
    .table-dark {
        background-color: #2a2a2a;
    }
    .error-message {
        color: #ff6b6b;
        margin-top: 5px;
    }
    .table-responsive {
        overflow-x: auto;
    }
    @media (max-width: 768px) {
        .col-md-6 {
            margin-bottom: 30px;
        }
    }
    .hidden {
        display: none;
    }
    .booking-select {
        margin-bottom: 20px;
    }
    .transaction-form {
        margin-bottom: 30px;
    }
</style>

<div class="container mt-5">
    <h1>Transactions</h1>

    <a href="/dashboard" class="btn btn-secondary mb-3">Back to Dashboard</a>
    
    <div class="row">
        <div class="col-md-6">
            <h2>Add Transaction</h2>
            <form id="add-transaction-form">
                <input type="hidden" id="booking-id" name="booking_id">
                <div class="form-group">
                    <label for="transaction-date">Select Date:</label>
                    <input type="date" id="transaction-date" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="booking-select">Select Booking:</label>
                    <select id="booking-select" class="form-control" required></select>
                </div>
                <div class="form-group">
                    <label for="booking-payment">Booking Payment:</label>
                    <input type="number" id="booking-payment" name="booking_payment" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="fee-payment">Fee Payment:</label>
                    <input type="number" id="fee-payment" name="fee_payment" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="discount">Discount:</label>
                    <input type="number" id="discount" name="discount" class="form-control" value="0">
                </div>
                <div class="form-group">
                    <label for="other-adjustments">Other Adjustments:</label>
                    <input type="number" id="other-adjustments" name="other_adjustments" class="form-control" value="0">
                </div>
                <div class="form-group">
                    <label for="cash-payment">Cash Payment:</label>
                    <input type="number" id="cash-payment" name="cash_payment" class="form-control" value="0">
                </div>
                <div class="form-group">
                    <label for="mobile-banking-payment">Mobile Banking Payment:</label>
                    <input type="number" id="mobile-banking-payment" name="mobile_banking_payment" class="form-control" value="0">
                </div>
                <div class="form-group">
                    <label for="bank-transfer-payment">Bank Transfer Payment:</label>
                    <input type="number" id="bank-transfer-payment" name="bank_transfer_payment" class="form-control" value="0">
                </div>
                <button type="submit" class="btn btn-primary">Add Transaction</button>
            </form>
            <div id="add-transaction-error" class="alert alert-danger mt-3" style="display: none;"></div>
        </div>
        <div class="col-md-6">
            <h2>Transaction List</h2>
            <div class="form-group">
                <label for="transaction-list-date">Select Date:</label>
                <input type="date" id="transaction-list-date" class="form-control">
            </div>
            <div class="table-responsive">
                <table id="transaction-table" class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Time Slot</th>
                            <th>Total Price</th>
                            <th>Booking Payment</th>
                            <th>Fee Payment</th>
                            <th>Discount</th>
                            <th>Other Adjustments</th>
                            <th>Leftover</th>
                            <th>Status</th>
                            <th>Cash</th>
                            <th>Mobile Banking</th>
                            <th>Bank Transfer</th>
                            <th>Created By</th>
                            <th>Updated By</th>
                            <th>Created At</th>
                            <th>Updated At</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Transaction rows will be inserted here dynamically -->
                    </tbody>
                </table>
            </div>
            <div id="transaction-list-error" class="alert alert-danger mt-3" style="display: none;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const dateInput = document.getElementById('transaction-date');
const bookingSelect = document.getElementById('booking-select');
const addTransactionForm = document.getElementById('add-transaction-form');
const transactionListDate = document.getElementById('transaction-list-date');
const transactionTable = document.getElementById('transaction-table').getElementsByTagName('tbody')[0];
const addTransactionError = document.getElementById('add-transaction-error');
const transactionListError = document.getElementById('transaction-list-error');
let slotPrices = {};

// Fetch slot prices on page load
fetch('/slot_prices')
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(prices => {
        slotPrices = prices;
    })
    .catch(error => {
        console.error('Error fetching slot prices:', error);
    });

dateInput.addEventListener('change', function() {
    fetchBookingsForDate(this.value);
});

bookingSelect.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const bookingId = selectedOption.value;
    const timeSlot = selectedOption.textContent.split(' - ')[0];
    
    document.getElementById('booking-id').value = bookingId;
    
    // Set the booking payment to the slot price if available
    if (slotPrices[timeSlot]) {
        document.getElementById('booking-payment').value = slotPrices[timeSlot];
    }
});

function fetchBookingsForDate(date) {
    fetch(`/bookings_for_date?date=${date}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(bookings => {
            bookingSelect.innerHTML = '<option value="">Select a booking</option>';
            bookings.forEach(booking => {
                const option = document.createElement('option');
                option.value = booking.id;
                option.textContent = `${booking.time_slot} - ${booking.name}`;
                option.style.color = booking.has_transaction ? 'green' : 'black';
                bookingSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error fetching bookings:', error);
            addTransactionError.textContent = 'Error fetching bookings. Please try again.';
            addTransactionError.style.display = 'block';
        });
}

addTransactionForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch('/add_transaction', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Transaction added successfully');
            fetchBookingsForDate(dateInput.value);
            fetchTransactionsForDate(dateInput.value);
            addTransactionForm.reset();
            addTransactionError.style.display = 'none';
        } else {
            throw new Error(data.message || 'Unknown error occurred');
        }
    })
    .catch(error => {
        console.error('Error adding transaction:', error);
        addTransactionError.textContent = 'Error adding transaction: ' + error.message;
        addTransactionError.style.display = 'block';
    });
});

transactionListDate.addEventListener('change', function() {
    fetchTransactionsForDate(this.value);
});


function fetchTransactionsForDate(date) {
    fetch(`/transactions_list?date=${date}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(transactions => {
            transactionTable.innerHTML = '';
            transactions.forEach(t => {
                const row = transactionTable.insertRow();
                row.innerHTML = `
                    <td>${t.id}</td>
                    <td>${t.booking.time_slot}</td>
                    <td>${t.total_price}</td>
                    <td>${t.booking_payment}</td>
                    <td>${t.fee_payment}</td>
                    <td>${t.discount}</td>
                    <td>${t.other_adjustments}</td>
                    <td>${t.leftover}</td>
                    <td>${t.status}</td>
                    <td>${t.cash_payment}</td>
                    <td>${t.mobile_banking_payment}</td>
                    <td>${t.bank_transfer_payment}</td>
                    <td>${t.creator}</td>
                    <td>${t.updater}</td>
                    <td>${new Date(t.created_at).toLocaleString()}</td>
                    <td>${new Date(t.updated_at).toLocaleString()}</td>
                `;
            });
            transactionListError.style.display = 'none';
        })
        .catch(error => {
            console.error('Error fetching transactions:', error);
            transactionListError.textContent = 'Error fetching transactions. Please try again.';
            transactionListError.style.display = 'block';
        });
}

// Initialize with today's date
const today = new Date().toISOString().split('T')[0];
dateInput.value = today;
transactionListDate.value = today;
fetchBookingsForDate(today);
fetchTransactionsForDate(today);
</script>
{% endblock %}