{% extends "base.html" %}

{% block content %}
<style>
    .alert-info-white {
        color: white;
    }
    .booking-table {
        width: 100%;
        overflow-x: auto;
    }
    .booking-table table {
        width: 100%;
        border-collapse: collapse;
    }
    .booking-table th, .booking-table td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: center;
        white-space: nowrap;
    }
    .booking-table th {
        background-color: #5c5656;
    }
    .booked {
        background-color: #be4644;
    }
    .open {
        background-color: #2e8d2e;
    }
    .booking-link {
        display: block;
        width: 100%;
        height: 100%;
        color: inherit;
        text-decoration: none;
    }
</style>

<h1 class="mt-5">Dashboard</h1>
<p>Welcome, {{ current_user.username }}!</p>
<a href="/logout" class="btn btn-secondary">Logout</a>

<h2 class="mt-5">Book a Slot</h2>
<form method="post" action="/book" id="bookingForm">
    <input type="hidden" name="booking_id" id="booking_id">
    <div class="form-group">
        <label for="name">Name</label>
        <input type="text" class="form-control" id="name" name="name" maxlength="25" required>
    </div>
    <div class="form-group">
        <label for="phone">Phone</label>
        <input type="text" class="form-control" id="phone" name="phone" required>
    </div>
    <div class="form-group">
        <label for="booking_date">Date</label>
        <input type="date" class="form-control" id="booking_date" name="booking_date" required>
    </div>
    <div class="form-group">
        <label for="time_slot">Time Slot</label>
        <select class="form-control" id="time_slot" name="time_slot" required>
            <option value="9:30 AM - 11:00 AM">9:30 AM - 11:00 AM</option>
            <option value="11:00 AM - 12:30 PM">11:00 AM - 12:30 PM</option>
            <option value="12:30 PM - 2:00 PM">12:30 PM - 2:00 PM</option>
            <option value="3:00 PM - 4:30 PM">3:00 PM - 4:30 PM</option>
            <option value="4:30 PM - 6:00 PM">4:30 PM - 6:00 PM</option>
            <option value="6:00 PM - 7:30 PM">6:00 PM - 7:30 PM</option>
            <option value="7:30 PM - 9:00 PM">7:30 PM - 9:00 PM</option>
            <option value="9:00 PM - 10:30 PM">9:00 PM - 10:30 PM</option>
        </select>
    </div>
    <button type="submit" class="btn btn-primary mt-3" id="bookButton">Book</button>
    <button type="button" class="btn btn-secondary mt-3" id="clearButton" style="display:none;">Clear Booking</button>
</form>

{% if messages %}
<div class="mt-5">
    {% for message in messages %}
    <div class="alert alert-info alert-info-white">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}

<h2 class="mt-5">Booking Grid</h2>
<div class="booking-table">
    <table>
        <thead>
            <tr>
                <th>Time Slot</th>
                {% for booking_date in date_range %}
                <th>{{ booking_date.strftime('%A') }}<br>{{ booking_date }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for time_slot in time_slots %}
            <tr>
                <td>{{ time_slot }}</td>
                {% for booking_date in date_range %}
                {% set booking = bookings_by_date_time.get((booking_date, time_slot)) %}
                <td class="{% if booking %}booked{% else %}open{% endif %}">
                    <a href="#" class="booking-link" data-date="{{ booking_date }}" data-time-slot="{{ time_slot }}" data-booking-id="{{ booking.id if booking }}">
                        {% if booking %}Booked{% else %}Open{% endif %}
                    </a>
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}


{% block scripts %}
<script>
    console.log("JavaScript loaded");
    document.querySelectorAll('.booking-link').forEach(link => {
        link.addEventListener('click', event => {
            event.preventDefault();
            console.log("Booking link clicked");
            const booking_date = link.getAttribute('data-date');
            const timeSlot = link.getAttribute('data-time-slot');
            const bookingId = link.getAttribute('data-booking-id');

            document.getElementById('booking_date').value = booking_date;
            document.getElementById('time_slot').value = timeSlot;
            document.getElementById('booking_id').value = bookingId;

            if (bookingId) {
                const bookingData = {{ bookings_by_date_time|tojson|safe }};
                const selectedBooking = bookingData[booking_date + '-' + timeSlot];
                document.getElementById('name').value = selectedBooking.name;
                document.getElementById('phone').value = selectedBooking.phone;

                document.getElementById('bookButton').textContent = 'Update Booking';
                document.getElementById('clearButton').style.display = 'inline-block';
            } else {
                document.getElementById('name').value = '';
                document.getElementById('phone').value = '';

                document.getElementById('bookButton').textContent = 'Book';
                document.getElementById('clearButton').style.display = 'none';
            }
        });
    });

    document.getElementById('clearButton').addEventListener('click', async () => {
        const bookingId = document.getElementById('booking_id').value;
        if (bookingId) {
            const response = await fetch(`/delete_booking/${bookingId}`, {
                method: 'DELETE',
            });
            if (response.ok) {
                location.reload();
            } else {
                alert('Failed to delete booking.');
            }
        }
    });
</script>
{% endblock %}